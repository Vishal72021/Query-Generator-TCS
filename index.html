<!DOCTYPE html>
<html lang="en" data-theme="red">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>CIBC Query Generator</title>

    <!-- Fonts: Inter for UI, Fira Code for code cells (professional) -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Fira+Code:wght@400;600&display=swap"
      rel="stylesheet"
    />

    <!-- Core Styles -->
    <link rel="stylesheet" href="css/tokens.css" />
    <link rel="stylesheet" href="css/components.css" />
    <link rel="stylesheet" href="css/layout.css" />
    <link rel="stylesheet" href="css/page.css" />
    <link rel="stylesheet" href="css/inputs.css" />
  </head>

  <body class="font-ui" data-page="main">
    <div class="app">
      <div class="main-wrap">
        <!-- NAVBAR -->
        <header class="navbar" role="banner" aria-label="Top navigation">
          <div class="nav-row container">
            <!-- Left -->
            <div class="nav-left brand">
              <img src="./assets/logo.png" alt="CIBC logo" class="brand-logo" />
              <div class="tag muted">ETL QA Agent</div>
            </div>

            <!-- Center nav -->
            <nav class="nav-center" aria-label="Primary">
              <a href="#" class="muted">Home</a>
              <a href="#" class="muted">Docs</a>
              <a href="#" class="muted">Contact</a>
            </nav>

            <!-- Right -->
            <div class="nav-right" aria-hidden="false">
              <!-- Sign control is managed by JS; we only keep the theme toggle here -->
              <button
                id="themeToggle"
                class="btn ghost"
                aria-pressed="false"
                title="Toggle theme"
              >
                üåó
              </button>
            </div>
          </div>
        </header>

        <!-- MAIN GRID -->
        <main>
          <!-- INTRO SECTION (JIRA BLOCK) -->
          <section class="intro" aria-labelledby="introHeading">
            <div class="intro-grid container">
              <div>
                <h1 id="introHeading">Welcome to CIBC's query generator</h1>
                <p class="muted">
                  Write and run Python and SQL queries with ease.
                </p>
              </div>

              <div>
                <div class="input-row">
                  <div class="input-group jira-key-group" id="jiraKeyWrapper">
                    <span class="input-icon" aria-hidden="true">
                      <svg width="16" height="16" viewBox="0 0 24 24">
                        <path
                          fill="currentColor"
                          d="M12 2a5 5 0 0 0-5 5v1H5v2h2v6h2v-6h2v6h2v-6h2v6h2v-9h-2V7a5 5 0 0 0-5-5z"
                        />
                      </svg>
                    </span>

                    <input
                      id="jiraKey"
                      type="password"
                      placeholder=""
                      aria-label="Enter JIRA key to generate"
                    />
                    <label class="floating-label" for="jiraKey"
                      >Enter JIRA key</label
                    >
                    <button
                      class="input-action"
                      type="button"
                      aria-label="Clear JIRA key"
                    >
                      ‚úï
                    </button>
                  </div>

                  <button id="authenticateBtn" class="btn primary auth-action">
                    Authenticate
                  </button>
                </div>

                <!-- Error line below the row -->
                <div
                  id="jiraError"
                  class="input-error hidden"
                  role="status"
                  aria-live="polite"
                >
                  Invalid JIRA key. Please enter a valid alphanumeric ticket.
                </div>
              </div>
            </div>
          </section>

          <!-- LEFT SIDEBAR -->
          <aside class="sidebar" aria-labelledby="connectionHeading">
            <h3 id="connectionHeading">Connection</h3>

            <!-- API Key Input -->
            <div class="input-group" aria-label="API token input">
              <span class="input-icon" aria-hidden="true">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <path
                    fill="currentColor"
                    d="M12 1a4 4 0 0 0-4 4v3H6v12h12V8h-2V5a4 4 0 0 0-4-4zM8 8V5a4 4 0 0 1 8 0v3H8z"
                  />
                </svg>
              </span>

              <input
                id="apiKey"
                type="password"
                placeholder=""
                aria-label="Paste API token"
              />
              <label class="floating-label" for="apiKey">Paste API token</label>
              <button
                class="input-action"
                type="button"
                aria-label="Clear API token"
              >
                ‚úï
              </button>
            </div>

            <button id="connectBtn" class="btn primary mt-12">Connect</button>

            <div class="tips mt-12">
              <p><strong>Tips</strong></p>
              <p>
                Prefix with <code>// sql</code> or <code>// python</code> to
                hint execution.
              </p>
              <p>Notebook auto-saves to local storage.</p>
            </div>

            <div class="actions-inline mt-12">
              <button id="importBtn" class="btn ghost" data-action="process">
                Import
              </button>
              <button id="exportBtn" class="btn ghost" data-action="process">
                Export
              </button>
            </div>
          </aside>

          <!-- NOTEBOOK / QUERY EDITOR -->
          <section class="notebook" aria-labelledby="notebookHeading">
            <h3 id="notebookHeading">Query generator</h3>

            <div id="cells" class="cells" role="list">
              <!-- CELL 1 -->
              <article class="cell" tabindex="-1" role="listitem">
                <div
                  class="reorder-handle drag-handle"
                  title="Drag to reorder"
                  aria-hidden="true"
                >
                  ‚â°
                </div>

                <!-- Floating mini-toolbar (appears on hover/focus) -->
                <div
                  class="cell-toolbar"
                  role="toolbar"
                  aria-label="Cell actions"
                >
                  <button
                    class="tool"
                    data-action="clone"
                    title="Clone cell"
                    aria-label="Clone"
                  >
                    üìÑ
                  </button>
                  <button
                    class="tool"
                    data-action="run"
                    title="Run cell"
                    aria-label="Run"
                  >
                    ‚ñ∂
                  </button>
                  <button
                    class="tool"
                    data-action="edit"
                    title="Edit cell"
                    aria-label="Edit"
                  >
                    ‚úé
                  </button>
                  <button
                    class="tool"
                    data-action="up"
                    title="Move up"
                    aria-label="Move up"
                  >
                    ‚Üë
                  </button>
                  <button
                    class="tool"
                    data-action="down"
                    title="Move down"
                    aria-label="Move down"
                  >
                    ‚Üì
                  </button>
                  <button
                    class="tool"
                    data-action="delete"
                    title="Delete"
                    aria-label="Delete"
                  >
                    üóë
                  </button>
                  <button
                    class="tool"
                    data-action="ai-explain"
                    title="Explain (AI)"
                    aria-label="Explain"
                  >
                    üí°
                  </button>
                  <button
                    class="tool"
                    data-action="ai-fix"
                    title="Fix (AI)"
                    aria-label="Fix"
                  >
                    üîß
                  </button>
                </div>

                <div class="content">
                  <!-- set class 'code-10' so CSS can size it for 10 lines -->
                  <div class="card">
                    <div
                      class="code code-10"
                      contenteditable="false"
                      spellcheck="false"
                      aria-label="Cell code"
                    >
                      # Example cell 1 print('Hello world')
                    </div>
                  </div>
                </div>
              </article>

              <!-- ADD-BETWEEN BUTTON (between cells) -->
              <div class="add-between" role="separator" aria-hidden="true">
                <button class="btn add-between-btn" title="Add cell">
                  Ôºã Add cell
                </button>
              </div>

              <!-- CELL 2 -->
              <article class="cell" tabindex="-1" role="listitem">
                <div
                  class="reorder-handle drag-handle"
                  title="Drag to reorder"
                  aria-hidden="true"
                >
                  ‚â°
                </div>

                <div
                  class="cell-toolbar"
                  role="toolbar"
                  aria-label="Cell actions"
                >
                  <button
                    class="tool"
                    data-action="clone"
                    title="Clone cell"
                    aria-label="Clone"
                  >
                    üìÑ
                  </button>
                  <button
                    class="tool"
                    data-action="run"
                    title="Run cell"
                    aria-label="Run"
                  >
                    ‚ñ∂
                  </button>
                  <button
                    class="tool"
                    data-action="edit"
                    title="Edit cell"
                    aria-label="Edit"
                  >
                    ‚úé
                  </button>
                  <button
                    class="tool"
                    data-action="up"
                    title="Move up"
                    aria-label="Move up"
                  >
                    ‚Üë
                  </button>
                  <button
                    class="tool"
                    data-action="down"
                    title="Move down"
                    aria-label="Move down"
                  >
                    ‚Üì
                  </button>
                  <button
                    class="tool"
                    data-action="delete"
                    title="Delete"
                    aria-label="Delete"
                  >
                    üóë
                  </button>
                  <button
                    class="tool"
                    data-action="ai-explain"
                    title="Explain (AI)"
                    aria-label="Explain"
                  >
                    üí°
                  </button>
                  <button
                    class="tool"
                    data-action="ai-fix"
                    title="Fix (AI)"
                    aria-label="Fix"
                  >
                    üîß
                  </button>
                </div>

                <div class="content">
                  <div class="card">
                    <div
                      class="code code-10"
                      contenteditable="false"
                      spellcheck="false"
                      aria-label="Cell code"
                    >
                      # Example cell 2 for i in range(3): print(i)
                    </div>
                  </div>
                </div>
              </article>

              <!-- ADD-BETWEEN BUTTON (after last existing cell) -->
              <div class="add-between" role="separator" aria-hidden="true">
                <button class="btn add-between-btn" title="Add cell">
                  Ôºã Add cell
                </button>
              </div>
            </div>

            <!-- actions above bottom -->
            <div class="actions-inline mt-12">
              <button id="runAllBtn" class="btn primary" disabled>
                Run all cells
              </button>
              <button id="updateDeltaBtn" class="btn ghost" disabled>
                Update to Delta table
              </button>
            </div>

            <!-- Notebook bottom actions (updated: Upload to SharePoint next to Run as new notebook) -->
            <div class="bottom-actions" style="align-items: center; gap: 12px">
              <div style="flex: 1"></div>
              <!-- pushes buttons to the right -->

              <button id="runAsNewBtn" class="btn primary">
                Run as new notebook
              </button>

              <!-- Upload to SharePoint (demo redirect) -->
              <button
                id="uploadSharePointBtn"
                class="btn upload"
                title="Upload to SharePoint"
              >
                <span>Upload to SharePoint</span>
                <svg
                  style="width: 16px; height: 16px; margin-left: 8px"
                  viewBox="0 0 24 24"
                  fill="none"
                  aria-hidden="true"
                >
                  <path
                    d="M12 3v12"
                    stroke="currentColor"
                    stroke-width="1.6"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M8 7l4-4 4 4"
                    stroke="currentColor"
                    stroke-width="1.6"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M5 21h14"
                    stroke="currentColor"
                    stroke-width="1.6"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </button>
            </div>
          </section>
        </main>
      </div>
    </div>

    <!-- SIGN IN MODAL -->
    <div
      id="signupModal"
      class="modal hidden"
      aria-hidden="true"
      role="dialog"
      aria-modal="true"
      aria-labelledby="signupTitle"
    >
      <div class="modal-backdrop" data-dismiss="modal"></div>
      <div class="modal-panel">
        <header class="modal-header">
          <h3 id="signupTitle">Sign in</h3>
          <button class="modal-close" aria-label="Close">‚úï</button>
        </header>

        <div class="modal-body">
          <p class="muted">
            Use demo credentials or continue with your account.
          </p>

          <div class="mt-8">
            <label class="modal-label">Username</label>
            <input
              id="modalUser"
              class="modal-input"
              type="text"
              placeholder="vishal-jira"
            />
          </div>

          <div class="mt-8">
            <label class="modal-label">API token</label>
            <input
              id="modalToken"
              class="modal-input"
              type="password"
              placeholder="vishal-token"
            />
          </div>

          <div
            style="
              display: flex;
              gap: 8px;
              justify-content: flex-end;
              margin-top: 14px;
            "
          >
            <button id="modalSignInBtn" class="btn primary">Sign in</button>
            <button class="btn ghost modal-close">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- C-GPT Floating Chat Widget (frontend-only, echo bot) -->
<script>
(function () {
  if (window.__cgpt_frontend_widget_loaded) return;
  window.__cgpt_frontend_widget_loaded = true;

  /* ===== styles (scoped) ===== */
  const css = `
  /* Container */
  .cgpt-widget { position: fixed; right:20px; bottom:20px; z-index:2147483646; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }

  /* Floating button */
  .cgpt-btn {
    width:64px; height:64px; border-radius:50%; border:0; display:grid; place-items:center;
    background: linear-gradient(135deg,#ff0033,#ff6f85); box-shadow:0 18px 40px rgba(0,0,0,0.45);
    cursor:pointer; transition: transform .18s ease, box-shadow .18s ease;
  }
  .cgpt-btn:hover { transform: translateY(-4px); }

  /* Panel */
  .cgpt-panel {
    width:420px; max-width:calc(100vw - 40px); height:640px; border-radius:14px; overflow:hidden;
    box-shadow: 0 30px 80px rgba(0,0,0,0.45); background:var(--cgpt-panel-bg, #fff); display:none;
    flex-direction:column; border:1px solid rgba(0,0,0,0.06);
  }
  .cgpt-panel.open { display:flex; animation:cgptPop .16s cubic-bezier(.2,.9,.3,1); }
  @keyframes cgptPop { from { transform: scale(.98) translateY(8px); opacity: 0 } to { transform: scale(1) translateY(0); opacity:1 } }

  /* Header */
  .cgpt-header { height:56px; display:flex; align-items:center; justify-content:space-between; padding:0 12px; border-bottom:1px solid rgba(0,0,0,0.04); background: linear-gradient(90deg,#fff6f6,#fff7f7); }
  .cgpt-brand { display:flex; gap:10px; align-items:center; }
  .cgpt-logo { width:36px; height:36px; border-radius:8px; display:grid; place-items:center; color:#fff; font-weight:900; background:linear-gradient(135deg,#ff0033,#ff6f85); box-shadow: 0 8px 24px rgba(255,0,80,0.12); }
  .cgpt-title { font-weight:800; }
  .cgpt-controls { display:flex; gap:8px; align-items:center; }

  .cgpt-small-btn { padding:8px 10px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background:transparent; cursor:pointer; font-weight:700; font-size:13px; }
  .cgpt-small-btn.icon { padding:8px; min-width:44px; display:grid; place-items:center; }

  /* Conversation */
  .cgpt-body { padding:14px; display:flex; flex-direction:column; gap:12px; overflow:auto; flex:1; background: linear-gradient(180deg,var(--cgpt-panel-bg, #fff), rgba(0,0,0,0.01)); }
  .cgpt-msg { max-width:78%; padding:12px 14px; border-radius:12px; line-height:1.45; font-size:14px; box-shadow:0 4px 10px rgba(0,0,0,0.04); word-break:break-word; }
  .cgpt-msg.bot { align-self:flex-start; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px dashed rgba(0,0,0,0.06); padding-left:20px; position:relative; }
  .cgpt-msg.bot::before { content:''; position:absolute; left:8px; top:50%; transform:translateY(-50%); width:6px; height:36px; border-radius:6px; background: linear-gradient(180deg,#ff7a90,#ff0033); box-shadow:0 6px 18px rgba(255,50,80,0.08); }
  .cgpt-msg.user { align-self:flex-end; background: linear-gradient(180deg,#fff,#fff8f8 30%); border:1px solid rgba(0,0,0,0.06); font-weight:600; }

  /* Composer */
  .cgpt-composer { padding:12px; border-top:1px solid rgba(0,0,0,0.04); display:flex; gap:10px; background:var(--cgpt-panel-bg, #fff); }
  .cgpt-textarea { flex:1; min-height:46px; max-height:160px; padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); resize:none; outline:none; font-size:14px; background:transparent; color:inherit; }
  .cgpt-send { padding:10px 14px; border-radius:10px; border:0; background:linear-gradient(135deg,#ff0033,#ff6f85); color:white; font-weight:800; cursor:pointer; }

  /* small theme menu */
  .cgpt-theme-menu { position:relative; }
  .cgpt-theme-pop { position:absolute; right:0; top:calc(100% + 10px); background:var(--cgpt-panel-bg, #fff); padding:10px; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,0.12); display:none; border:1px solid rgba(0,0,0,0.06); }
  .cgpt-theme-pop.open { display:block; }
  .cgpt-theme-opt { padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:700; display:flex; gap:8px; align-items:center; }
  .cgpt-theme-sw { width:36px; height:20px; border-radius:6px; border:1px solid rgba(0,0,0,0.06); }

  /* dark adjustments (we'll toggle CSS vars) */
  /* small responsive */
  @media (max-width:520px){
    .cgpt-panel{ right:12px; left:12px; bottom:12px; top:12px; width:auto; height:auto; max-height:calc(100vh - 24px) }
    .cgpt-body{ padding:12px }
  }
  `;

  const style = document.createElement('style');
  style.setAttribute('data-cgpt', 'widget-styles');
  style.innerHTML = css;
  document.head.appendChild(style);

  /* ===== create DOM ===== */
  const widget = document.createElement('div');
  widget.className = 'cgpt-widget';

  widget.innerHTML = `
    <button class="cgpt-btn" aria-label="Open chat" title="Chat with C-GPT">
      <svg viewBox="0 0 24 24" width="28" height="28" fill="none" aria-hidden="true"><path d="M12 3a9 9 0 00-9 9c0 2.5 1 4.8 2.8 6.4L5 21l2.6-1.3A9 9 0 1012 3z" fill="#fff"/></svg>
    </button>

    <div class="cgpt-panel" role="dialog" aria-label="C-GPT chat panel" aria-hidden="true">
      <div class="cgpt-header">
        <div class="cgpt-brand">
          <div class="cgpt-logo">C</div>
          <div>
            <div class="cgpt-title">C-GPT</div>
            <div class="cgpt-muted" style="font-size:12px;color:var(--cgpt-muted,#6b7280)">Assistant</div>
          </div>
        </div>

        <div class="cgpt-controls">
          <div class="cgpt-theme-menu" style="position:relative">
            <button class="cgpt-small-btn icon" title="Theme" id="cgptThemeBtn">‚öôÔ∏è</button>
            <div class="cgpt-theme-pop" id="cgptThemePop" aria-hidden="true">
              <div class="cgpt-theme-opt" data-theme="red"><span class="cgpt-theme-sw" style="background:linear-gradient(90deg,#ff0033,#ff6f85)"></span> Red</div>
              <div class="cgpt-theme-opt" data-theme="black"><span class="cgpt-theme-sw" style="background:linear-gradient(90deg,#0b0d10,#2f9cff)"></span> Black</div>
              <div class="cgpt-theme-opt" data-theme="white"><span class="cgpt-theme-sw" style="background:linear-gradient(90deg,#ffffff,#ff6b7a)"></span> White</div>
            </div>
          </div>

          <button class="cgpt-small-btn" id="cgptShareBtn" title="Share (layout-only)">Share</button>
          <button class="cgpt-small-btn" id="cgptLoginBtn" title="Log in (layout-only)">Log in</button>
        </div>
      </div>

      <div class="cgpt-body" id="cgptBody" aria-live="polite"></div>

      <div class="cgpt-composer">
        <textarea class="cgpt-textarea" id="cgptInput" placeholder="Type a message ‚Äî Enter to send"></textarea>
        <button class="cgpt-send" id="cgptSend">Send</button>
      </div>
    </div>
  `;

  document.body.appendChild(widget);

  /* ===== utilities & state ===== */
  const $btn = widget.querySelector('.cgpt-btn');
  const $panel = widget.querySelector('.cgpt-panel');
  const $body = widget.querySelector('#cgptBody');
  const $input = widget.querySelector('#cgptInput');
  const $send = widget.querySelector('#cgptSend');
  const $themeBtn = widget.querySelector('#cgptThemeBtn');
  const $themePop = widget.querySelector('#cgptThemePop');

  // theme defaults & helper
  function applyTheme(mode) {
    // set CSS variables on :root to style the widget
    const root = document.documentElement;
    root.setAttribute('data-theme', mode);
    if (mode === 'red') {
      root.style.setProperty('--cgpt-panel-bg', '#fffafa');
      root.style.setProperty('--cgpt-muted', '#7b3a3a');
    } else if (mode === 'black') {
      root.style.setProperty('--cgpt-panel-bg', '#0e0e0f');
      root.style.setProperty('--cgpt-muted', '#9da6b2');
    } else { // white
      root.style.setProperty('--cgpt-panel-bg', '#ffffff');
      root.style.setProperty('--cgpt-muted', '#6f6f6f');
    }
    localStorage.setItem('cgpt_widget_theme', mode);
  }

  // load saved theme
  const savedTheme = localStorage.getItem('cgpt_widget_theme') || 'red';
  applyTheme(savedTheme);

  /* ===== open / close behavior ===== */
  function openPanel() {
    $panel.classList.add('open');
    $panel.setAttribute('aria-hidden', 'false');
    // focus textarea slightly later
    setTimeout(() => $input.focus(), 140);
  }
  function closePanel() {
    $panel.classList.remove('open');
    $panel.setAttribute('aria-hidden', 'true');
  }

  $btn.addEventListener('click', () => {
    if ($panel.classList.contains('open')) closePanel();
    else openPanel();
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closePanel();
    // ctrl/cmd+k to focus input
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
      e.preventDefault();
      openPanel();
      $input.focus();
    }
  });

  /* ===== theme menu ===== */
  $themeBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    $themePop.classList.toggle('open');
  });
  $themePop.addEventListener('click', (e) => {
    const opt = e.target.closest('.cgpt-theme-opt');
    if (!opt) return;
    const t = opt.getAttribute('data-theme');
    applyTheme(t);
    $themePop.classList.remove('open');
  });
  // close theme on outside click
  document.addEventListener('click', (e) => {
    if (!$themePop.contains(e.target) && e.target !== $themeBtn) $themePop.classList.remove('open');
  });

  /* ===== rendering messages ===== */
  function escapeHTML(s) {
    return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function appendMessage(who, text, opts = {}) {
    const el = document.createElement('div');
    el.className = 'cgpt-msg ' + (who === 'user' ? 'user' : 'bot');
    // allow small markdown-like line breaks
    const lines = escapeHTML(text).split('\n').map(l => `<div>${l}</div>`).join('');
    el.innerHTML = lines;
    $body.appendChild(el);
    // scroll to bottom smoothly
    $body.scrollTop = $body.scrollHeight;
    if (opts.focus) $input.focus();
    return el;
  }

  /* ===== echo behavior (simulate streaming) ===== */
  function botEcho(text) {
    // Show placeholder bot message
    const placeholder = appendMessage('bot', '...', { focus: false });
    // simulate typing chunks
    let acc = '';
    const delayBase = 40;
    const chunks = splitIntoChunks(text);
    let i = 0;
    const iv = setInterval(() => {
      if (i >= chunks.length) {
        clearInterval(iv);
        // finalize content
        placeholder.innerHTML = escapeHTML(text).split('\n').map(l => `<div>${l}</div>`).join('');
        $body.scrollTop = $body.scrollHeight;
        return;
      }
      acc += chunks[i++];
      placeholder.innerHTML = escapeHTML(acc).split('\n').map(l => `<div>${l}</div>`).join('');
      $body.scrollTop = $body.scrollHeight;
    }, delayBase + Math.random() * 80);
  }
  function splitIntoChunks(s) {
    // split into word-ish chunks for nicer streaming look
    if (!s) return [''];
    const words = s.split(/(\s+)/); // keep spaces
    const chunks = [];
    let acc = '';
    for (const w of words) {
      acc += w;
      if (acc.length > 20) { chunks.push(acc); acc = ''; }
    }
    if (acc) chunks.push(acc);
    return chunks;
  }

  /* ===== composer behavior ===== */
  function sendMessageFromComposer() {
    const txt = $input.value.trim();
    if (!txt) return;
    // add user message
    appendMessage('user', txt, { focus: true });
    $input.value = '';
    $input.style.height = 'auto';

    // echo back after tiny delay (simulate thinking)
    setTimeout(() => {
      botEcho(txt); // echo for now
    }, 300 + Math.random() * 400);
  }

  $send.addEventListener('click', () => sendMessageFromComposer());
  $input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessageFromComposer();
    }
  });
  // auto-resize textarea
  $input.addEventListener('input', () => {
    $input.style.height = 'auto';
    $input.style.height = Math.min($input.scrollHeight, 220) + 'px';
  });

  /* ===== initial greeting ===== */
  appendMessage('bot', 'Hello ‚Äî this demo chat echoes whatever you type. Theme and layout are frontend-only.');

  /* ===== expose small API on window for testing ===== */
  window.CGPT_FRONTEND = {
    open: openPanel,
    close: closePanel,
    appendMessage: (who, text) => appendMessage(who, text),
    setTheme: (t) => applyTheme(t)
  };
})();
</script>


    <!-- JS (keep original order) -->
    <script type="module" src="js/runner.js"></script>
    <script type="module" src="js/dragdrop.js"></script>
    <script type="module" src="js/wiring.js"></script>
    <script type="module" src="js/import-export.js"></script>

    <!-- UI enhancements -->
    <script type="module" src="js/ui.js"></script>
    <script type="module" src="js/inputs.js"></script>
    <script type="module" src="js/auth-demo.js"></script>
  </body>
</html>
